<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <title>CC-MEI-2018</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <link rel="stylesheet" href="labs.css" >
</head>
<body>

<div id="menu">

</div>

<div class="container">

    <div class="row">
        <div class="col-md-12">
            <h2 class="page-header">3. Interacting with users and services in the Cloud
            </h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="pull-right">
                <img src="https://www.lomasnuevo.net/wp-contentupl/2016/11/googlecloud.png" class="img" style="height: 200px;
padding-bottom: 20px;"/></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="autosection">numsection</span> Prepare for the lab</h3>
                </div>
                <div class="panel-body">
                    <p><strong class="autotask">task</strong>: Prepare a Docker container for this lab</p>
                    <pre><code class="bash">#update image
docker pull jorditorresbcn/dl
#Create a container
docker run -it -p 8888:8888 -p 8954:8954 jorditorresbcn/dl:latest
#Clone the course repository
git clone https://github.com/jorditorresBCN/CC-MEI-2018.git
cd CC-MEI-2018
#Ignore the error-> No web browser found: could not locate runnable browser.
jupyter notebook --ip=0.0.0.0 --allow-root</code></pre>

                    <p>If you close the container and you need to re-open it, run:</p>

                    <pre><code class="bash">docker ps -a
docker start -i YOUR_CONTAINER_ID</code></pre>

                    <p>On your computer, open your browser and go to <a href="http://localhost:8888" target="_blank">http://localhost:8888</a>,the password is <strong>dl</strong>.</p>

                    <p>If you are on windows and you are experiencing connectivity issues, please check <a
                            href="https://github.com/jorditorresBCN/dlaimet/blob/master/windows_proxy.md"
                            target="_blank">THIS</a>.</p>
                </div>
            </div>


            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="autosection">numsection</span> How to provide your services through an API?</h3>
                </div>
                <div class="panel-body">
                    <p>As we show, we can plots in Python using libraries like matplotlib.
                        However, how to provide our results through an API to consumers? In this lab we will use the
                        <a href="http://flask.pocoo.org/" target="_blank">Flask</a> framework to
                    create a simple API.</p>

                    <p><strong class="autotask">task</strong>: Open the notebook <code>flask_api_notebook.ipynb</code> and review the code.</p>

                    <p><strong class="autotask">task</strong>: Fulfill the Twitter variables with the same keys as the last lab.</p>

                                        <pre><code class="python"># Twitter Keys
consumer_key = ''
consumer_secret = ''
access_token = ''
access_secret = ''
</code></pre>
                    <p>The structure of an API view using <a href="http://flask.pocoo.org/" target="_blank">Flask</a>
                        should be something like this:</p>

                    <pre><code class="python"># The route of our view and the accepted methods.
@app.route('/url', methods=['METHOD'])
def process_some_data():
    # Compute data
    data = ...
    # Return data using JSON format
    return jsonify(data)
</code></pre>
                
                    <p><strong class="autotask">task</strong>: The first function of our API will be a method that
                        returns our Twitter account info. Paste the following code before the main function and run
                        all the blocks.</p>

                    <pre><code class="python">@app.route('/api/twitter', methods=['GET'])
def get_twitter_data():
    auth = OAuthHandler(consumer_key, consumer_secret)
    auth.set_access_token(access_token, access_secret)
    api = tweepy.API(auth)
    user = api.me()

    data = {
        'screen_name': user.screen_name,
        'name': user.name,
        'location': user.location,
        'followers': str(user.followers_count),
        'created': str(user.created_at),
        'description': str(user.description),
        'profile_image': str(user.profile_image_url)
    }

    return jsonify(data)
</code></pre>

                    <p>At this point, you can go to <a href="http://localhost:8954/api/twitter" target="_blank">
                        http://localhost:8954/api/twitter</a> and you will see a JSON with your Twitter account information.</p>

                    <p><strong class="autotask">task</strong>: Upload the file <code>filename</code>
                        (downloaded from "El Rac√≥") to the Jupyter Notebook as you did during the last lab.</p>
                    <p><strong class="autotask">task</strong>: Add the following code after the first method of the API, modify
                    the <code>fname</code> in the two functions if it is necessary.</p>

                    <pre><code class="python">@app.route('/api/twitter/datafrequency', methods=['GET'])
def process_twitter_data():
    fname = 'Lab3.CaseStudy.json'
    with open(fname, 'r') as f:
        count_all = Counter()
        for line in f:
            tweet = json.loads(line)
            # Create a list with all the terms
            terms_hash = [term for term in preprocess(tweet['text']) if term.startswith('#') and term not in stop]
            count_all.update(terms_hash)
    # Print the first 15 most frequent words
    data = {
        'file_name': fname,
        'words': count_all.most_common(15)
    }
    return jsonify(data)


@app.route('/api/twitter/datamap', methods=['GET'])
def process_twitter_data_map():
    fname = 'Lab3.CaseStudy.json'
    with open(fname, 'r') as f:
        geo_data = {
            "type": "FeatureCollection",
            "features": []
        }
        for line in f:
            tweet = json.loads(line)
            if tweet['coordinates']:
                geo_json_feature = {
                    "type": "Feature",
                    "geometry": tweet['coordinates'],
                    "properties": {
                        "text": tweet['text'],
                        "created_at": tweet['created_at']
                    }
                }
                geo_data['features'].append(geo_json_feature)
    return jsonify(geo_data)
</code></pre>
                    <p>This two functions returns data extracted from the file that you have uploaded to Jupyter.
                        The first one returns the first 15 most frequent hashtags, the second one returns the location of the tweets.
                    You can check if they are working visiting the urls that are in the <code>@app.route</code> decorator.</p>
                      </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="autosection">numsection</span> Consuming the API data</h3>
                </div>
                <div class="panel-body">
                    <p><strong class="autotask">task</strong>: Download the repository of the course to your computer. Click
                    <a href="https://github.com/jorditorresBCN/CC-MEI-2018/archive/master.zip">HERE</a> to download it and then
                        un-compress it.
                    </p>
                    
                    <p><strong class="autotask">task</strong>: Look for the file <code>api_client.html</code> file
                    and open it with your browser and using a code editor (e.g. Sublime Text). You will see a website
                    with different sections, each section works with each view that we created before. If you press the load buttons,
                    a Javascript code will call the API an parse the JSON into HTML. Check if your API is running on Jupyter
                    and press the load buttons. We used <a href="https://jquery.com/" target="_blank">Jquery</a>
                        to perform the asynchronous API calls.</p>

                    <div class="center-image">
                        <img src="img/api_client.png"
                             style="height: 75%"/>
                    </div>

                    <p>The following code shows how a simple API call works, it is the call for the first view of the API. The method
                        <code>loadTwitterAccount</code> is linked to the first load button.</p>

                    <pre><code class="javascript">function loadTwitterAccount() {
    $.get(api_url+"/api/twitter", function (data) {
        $('#screen_name').html("@" + data.screen_name);
        $('#name').html(data.name);
        $('#description').html(data.description);
        $('#followers').html("Followers: " + data.followers);
        $('#location').html(data.location);
        $('#profile_image').attr('src', data.profile_image);
    });
}
</code></pre>

                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="autosection">numsection</span> Lab report</h3>
                </div>
                <div class="panel-body">
                    <p>Please, follow the
                        indications of your teacher about how to create your lab report and how to submit it.</p>
                </div>
            </div>

        </div>
    </div>
</div>


</div><!-- /.container -->


<script
        src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
        crossorigin="anonymous"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
<script type="application/javascript">
    hljs.initHighlightingOnLoad();
    var numlab = 3
</script>
<script src="autonum.js"></script>
<script src="autoload.js"></script>

</body>
</html>